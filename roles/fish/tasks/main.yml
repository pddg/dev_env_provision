- include_tasks: brew.yml
  when: ansible_os_family == 'Darwin'

- include_tasks: apt.yml
  when: ansible_os_family == 'Debian'

- name: Obtain path to fish
  shell: which fish
  register: fish_path
  changed_when: false
  check_mode: no

- name: Add fish shell to /etc/shells
  lineinfile:
    dest: /etc/shells
    line: '{{ fish_path.stdout }}'
  become: yes

- name: Setup user shell
  user:
    name: '{{ ansible_env.USER }}'
    shell: '{{ fish_path.stdout }}'
  become: yes

- name: Create fish config dir
  file:
    path: "{{ item }}"
    state: directory
  loop:
    - "{{ fish_config_dir }}"
    - "{{ fish_config_dir }}/functions"

- name: Install fisherman
  get_url:
    url: https://git.io/fisher
    dest: "{{ fish_config_dir }}/functions/fisher.fish"
  register: download_result
  until: download_result is succeeded
  retries: 3
  delay: 5

- name: Put config files
  file:
    src: '{{ dotfiles_repo }}/{{ item }}'
    dest: '{{ ansible_env.HOME }}/{{ item }}'
    state: link
    force: yes
  loop: '{{ fish_config_files }}'

- name: Install fish plugins
  shell: fisher
  args:
    executable: "{{ fish_path.stdout }}"
  changed_when: false
